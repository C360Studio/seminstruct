name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: c360studio/seminstruct
  RUST_VERSION: "1.85"

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Allow time for shimmy build + model download

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build services (shimmy from source + seminstruct)
        run: |
          echo "Building shimmy from source and seminstruct..."
          docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Start services
        run: |
          echo "Starting services with small model (Qwen2.5-0.5B)..."
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d

      - name: Wait for shimmy model load
        run: |
          echo "Waiting for shimmy to download and load model..."
          for i in {1..90}; do
            if curl -sf http://localhost:11435/health 2>/dev/null; then
              echo "Shimmy is ready!"
              exit 0
            fi
            echo "Attempt $i/90: Model loading..."
            sleep 5
          done
          echo "Shimmy failed to start"
          docker compose logs shimmy
          exit 1

      - name: Wait for seminstruct
        run: |
          echo "Waiting for seminstruct to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8083/health 2>/dev/null; then
              echo "Seminstruct is ready!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready yet..."
            sleep 2
          done
          echo "Seminstruct failed to start"
          docker compose logs seminstruct
          exit 1

      - name: Test health endpoint
        run: |
          response=$(curl -s http://localhost:8083/health)
          echo "Health response: $response"
          echo "$response" | grep -q '"shimmy_healthy":true' || (echo "Expected shimmy_healthy:true" && exit 1)

      - name: Test ready endpoint
        run: |
          response=$(curl -s http://localhost:8083/ready)
          echo "Ready response: $response"
          # Should return 200 with ready:true after model is loaded
          echo "$response" | grep -q '"ready":true' || (echo "Expected ready:true" && exit 1)

      - name: Test metrics endpoint
        run: |
          metrics=$(curl -s http://localhost:8083/metrics)
          echo "Checking metrics..."
          echo "$metrics" | grep -q 'seminstruct_requests_total' || exit 1
          echo "$metrics" | grep -q 'seminstruct_request_duration_seconds' || exit 1

      - name: Test chat completions endpoint (integration)
        run: |
          echo "Testing chat completions endpoint..."
          # Get available models from shimmy
          models=$(curl -s http://localhost:8083/v1/models)
          echo "Available models: $models"
          # Find qwen model (shimmy may list default phi3-lora first)
          model_id=$(echo "$models" | jq -r '.data[] | select(.id | contains("qwen")) | .id' | head -1)
          if [ -z "$model_id" ]; then
            # Fallback to last model if qwen not found
            model_id=$(echo "$models" | jq -r '.data[-1].id // empty')
          fi
          echo "Selected model: $model_id"
          response=$(curl -s http://localhost:8083/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d "{\"model\":\"$model_id\",\"messages\":[{\"role\":\"user\",\"content\":\"Say hello\"}],\"max_tokens\":20,\"stream\":false}")
          echo "Response: $response"
          # Verify we get valid JSON with actual content
          echo "$response" | jq -e '.choices[0].message.content' || (echo "No content in response" && exit 1)
          echo "Integration test passed!"

      - name: View shimmy logs
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs shimmy

      - name: View seminstruct logs
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs seminstruct

      - name: Stop services
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          ignore: DL3008,DL3009  # Ignore apt-get version pinning warnings

  push:
    name: Push to GHCR
    runs-on: ubuntu-latest
    needs: [build, security, lint]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=main-{{sha}},enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  push-shimmy:
    name: Push Shimmy to GHCR
    runs-on: ubuntu-latest
    needs: [build, security, lint]
    # Only push shimmy when its Dockerfile changes, or on manual trigger
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && contains(github.event.head_commit.modified, 'Dockerfile.shimmy'))
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/c360studio/semshimmy
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=qwen2.5-0.5b,enable={{is_default_branch}}
            type=raw,value=main-{{sha}},enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.shimmy
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
